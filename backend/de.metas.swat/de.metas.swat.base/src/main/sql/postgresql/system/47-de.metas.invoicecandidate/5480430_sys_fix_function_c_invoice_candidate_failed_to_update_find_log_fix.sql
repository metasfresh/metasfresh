
-- DROP FUNCTION de_metas_invoicecandidate.c_invoice_candidate_failed_to_update_find_log_fix();

CREATE OR REPLACE FUNCTION de_metas_invoicecandidate.c_invoice_candidate_failed_to_update_find_log_fix()
  RETURNS void AS
$BODY$

INSERT INTO de_metas_invoicecandidate.C_Invoice_Candidate_Failed_To_Update (
	found,
    reenqueued,
    iserroracknowledged,
    problem_found_by,
    ad_client_id,
    ad_org_id,
    c_invoice_candidate_id,
    c_orderline_id,
    created,
    createdby,
    isactive,
    qtytoinvoice,
    updated,
    updatedby,
    schedulerresult,
    priceactual_override,
    discount_override,
    bill_bpartner_id,
    bill_location_id,
    bill_user_id,
    invoicerule,
    qtytoinvoicenetamt,
    dateinvoiced,
    istoclear,
    m_product_id,
    dateordered,
    processed,
    priceactual,
    c_currency_id,
    qtyordered,
    qtydelivered,
    qtyinvoiced,
    qtytoinvoice_override,
    qtytoinvoice_overridefulfilled,
    c_charge_id,
    bill_bpartner_override_id,
    invoicerule_override,
    m_pricingsystem_id,
    discount,
    netamttoinvoice,
    netamtinvoiced,
    c_invoice_candidate_agg_id,
    lineaggregationkey,
    lineaggregationkey_suffix,
    c_ilcandhandler_id,
    ad_table_id,
    record_id,
    iserror,
    ad_note_id,
    errormsg,
    datetoinvoice,
    datetoinvoice_override,
    c_conversiontype_id,
    invoicescheduleamtstatus,
    ismanual,
    description,
    ad_user_incharge_id,
    headeraggregationkey,
    splitamt,
    descriptionheader,
    descriptionbottom,
    priceentered,
    priceentered_override,
    issotrx,
    qualitydiscountpercent_effective,
    qualitynote_receiptschedule,
    qualitydiscountpercent,
    qualitydiscountpercent_override,
    isindispute,
    qtywithissues,
    qtyorderedoverunder,
    reasondiscount,
    c_uom_id,
    price_uom_id,
    c_order_id,
    c_activity_id,
    c_tax_id,
    qtytoinvoiceinpriceuom,
    isprinted,
    line,
    c_doctypeinvoice_id,
    m_material_tracking_id,
    approvalforinvoicing,
    c_tax_override_id,
    poreference,
    dateacct,
    deliverydate,
    m_inout_id,
    priceactual_net_effective,
    istaxincluded,
    qtyenteredtu,
    qtytoinvoicebeforediscount,
    istaxincluded_override,
    c_invoice_candidate_headeraggregation_id,
    c_invoice_candidate_headeraggregation_override_id,
    headeraggregationkey_calc,
    c_invoice_candidate_headeraggregation_effective_id,
    headeraggregationkeybuilder_id,
    first_ship_bplocation_id,
    isinoutapprovedforinvoicing,
    qtywithissues_effective,
    processed_override,
    processed_calc,
    task_08848_fixed,
    lineaggregationkeybuilder_id,
    ispackagingmaterial,
    isedirecipient,
    isedienabled,
    m_pricelist_version_id,
    qualityinvoicelinegrouptype
)
SELECT 
found,
    reenqueued,
    iserroracknowledged,
    problem_found_by,
    ad_client_id,
    ad_org_id,
    c_invoice_candidate_id,
    c_orderline_id,
    created,
    createdby,
    isactive,
    qtytoinvoice,
    updated,
    updatedby,
    schedulerresult,
    priceactual_override,
    discount_override,
    bill_bpartner_id,
    bill_location_id,
    bill_user_id,
    invoicerule,
    qtytoinvoicenetamt,
    dateinvoiced,
    istoclear,
    m_product_id,
    dateordered,
    processed,
    priceactual,
    c_currency_id,
    qtyordered,
    qtydelivered,
    qtyinvoiced,
    qtytoinvoice_override,
    qtytoinvoice_overridefulfilled,
    c_charge_id,
    bill_bpartner_override_id,
    invoicerule_override,
    m_pricingsystem_id,
    discount,
    netamttoinvoice,
    netamtinvoiced,
    c_invoice_candidate_agg_id,
    lineaggregationkey,
    lineaggregationkey_suffix,
    c_ilcandhandler_id,
    ad_table_id,
    record_id,
    iserror,
    ad_note_id,
    errormsg,
    datetoinvoice,
    datetoinvoice_override,
    c_conversiontype_id,
    invoicescheduleamtstatus,
    ismanual,
    description,
    ad_user_incharge_id,
    headeraggregationkey,
    splitamt,
    descriptionheader,
    descriptionbottom,
    priceentered,
    priceentered_override,
    issotrx,
    qualitydiscountpercent_effective,
    qualitynote_receiptschedule,
    qualitydiscountpercent,
    qualitydiscountpercent_override,
    isindispute,
    qtywithissues,
    qtyorderedoverunder,
    reasondiscount,
    c_uom_id,
    price_uom_id,
    c_order_id,
    c_activity_id,
    c_tax_id,
    qtytoinvoiceinpriceuom,
    isprinted,
    line,
    c_doctypeinvoice_id,
    m_material_tracking_id,
    approvalforinvoicing,
    c_tax_override_id,
    poreference,
    dateacct,
    deliverydate,
    m_inout_id,
    priceactual_net_effective,
    istaxincluded,
    qtyenteredtu,
    qtytoinvoicebeforediscount,
    istaxincluded_override,
    c_invoice_candidate_headeraggregation_id,
    c_invoice_candidate_headeraggregation_override_id,
    headeraggregationkey_calc,
    c_invoice_candidate_headeraggregation_effective_id,
    headeraggregationkeybuilder_id,
    first_ship_bplocation_id,
    isinoutapprovedforinvoicing,
    qtywithissues_effective,
    processed_override,
    processed_calc,
    task_08848_fixed,
    lineaggregationkeybuilder_id,
    ispackagingmaterial,
    isedirecipient,
    isedienabled,
    m_pricelist_version_id,
    qualityinvoicelinegrouptype
FROM de_metas_invoicecandidate.C_Invoice_Candidate_Failed_To_Update_v;

WITH source as (
	UPDATE de_metas_invoicecandidate.C_Invoice_Candidate_Failed_To_Update 
	SET reenqueued=now() 
	WHERE reenqueued is null
	RETURNING C_Invoice_Candidate_ID
)
INSERT INTO C_Invoice_Candidate_Recompute
SELECT C_Invoice_Candidate_ID
FROM source;

$BODY$
  LANGUAGE sql VOLATILE
  COST 100;

COMMENT ON FUNCTION de_metas_invoicecandidate.c_invoice_candidate_failed_to_update_find_log_fix() IS 'Executes the view de_metas_invoicecandidate.C_Invoice_Candidate_Failed_To_Update_v and inserts the results into the table de_metas_invoicecandidate.C_Invoice_Candidate_Failed_To_Update.
Then it inserts the problematic ICs'' C_Invoice_Candidate_IDs into C_Invoice_Candidate_Recompute
Issue FRESH-93';
